name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test-backend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  cd backend
                  pip install -r requirements.txt

            - name: Run tests
              run: |
                  cd backend
                  pytest -v --cov=app --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./backend/coverage.xml

    test-frontend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci

            - name: Run tests
              run: |
                  cd frontend
                  npm test -- --coverage

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: ./frontend/coverage/lcov.info

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Lint backend
              run: |
                  cd backend
                  pip install flake8 black mypy
                  flake8 app tests
                  black --check app tests

            - name: Lint frontend
              run: |
                  cd frontend
                  npm ci
                  npm run lint

    build:
        runs-on: ubuntu-latest
        needs: [test-backend, test-frontend, lint]
        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build backend image
              run: docker build -t virtuserve-backend:latest ./backend

            - name: Build frontend image
              run: docker build -t virtuserve-frontend:latest ./frontend
